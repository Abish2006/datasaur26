<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>F.I.R.E. — Панель управления</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .stat-card { border-left: 4px solid; }
    .stat-total  { border-color: #0d6efd; }
    .stat-ok     { border-color: #198754; }
    .stat-warn   { border-color: #dc3545; }
    .stat-metric { border-color: #6f42c1; }
    th { white-space: nowrap; }
    .badge-priority { min-width: 2rem; }
    .metric-value { font-size: 1.5rem; font-weight: 700; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">&#128293; F.I.R.E. — Freedom Intelligent Routing Engine</span>
    <div class="d-flex align-items-center gap-2">
      <a href="#" id="btnProcess" class="btn btn-success btn-sm"
         onclick="startProcessing(event)">&#9654; Запустить обработку</a>
      <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#uploadArea">&#128206; Загрузить CSV</button>
      <a href="/export"  class="btn btn-outline-light btn-sm">&#128190; Экспорт SQL</a>
      <a href="/export/csv" class="btn btn-outline-light btn-sm">&#128196; Экспорт CSV</a>
      <a href="/reset"   class="btn btn-outline-danger btn-sm">&#8635; Сброс</a>
    </div>
  </div>
</nav>

<!-- Upload collapse area -->
<div class="collapse" id="uploadArea">
  <div class="container-fluid mb-3">
    <div class="card shadow-sm border-info">
      <div class="card-body">
        <form action="/upload" method="post" enctype="multipart/form-data" class="d-flex align-items-center gap-3">
          <label class="form-label mb-0 fw-semibold text-nowrap">Новые обращения (CSV):</label>
          <input type="file" name="file" accept=".csv" class="form-control form-control-sm" required style="max-width:350px;">
          <button type="submit" class="btn btn-info btn-sm text-nowrap" onclick="this.innerHTML='&#9203; Загрузка…';this.disabled=true;this.form.submit();">&#128228; Загрузить</button>
          <span class="text-muted small">Файл будет добавлен к существующим данным (дубликаты GUID пропускаются)</span>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">

  <!-- Карточки статистики -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card stat-card stat-total h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Всего обращений</div>
          <div class="display-6 fw-bold">{{ total }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card stat-ok h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Обработано</div>
          <div class="display-6 fw-bold text-success">{{ processed }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card stat-warn h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Без назначения (ручная проверка)</div>
          <div class="display-6 fw-bold text-danger">{{ unassigned }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Ожидает обработки</div>
          <div class="display-6 fw-bold text-warning">{{ total - processed }}</div>
        </div>
      </div>
    </div>
  </div>

  {% if processed > 0 %}
  <!-- Метрики качества маршрутизации -->
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-semibold">Метрики качества маршрутизации</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <div class="card stat-card stat-metric h-100">
            <div class="card-body text-center">
              <div class="text-muted small">VIP-соответствие</div>
              <div class="metric-value {% if metrics.vip_compliance == 100 %}text-success{% elif metrics.vip_compliance >= 80 %}text-warning{% else %}text-danger{% endif %}">
                {{ metrics.vip_compliance }}%
              </div>
              <div class="text-muted small">{{ metrics.vip_correct }}/{{ metrics.vip_total }} VIP-обращений</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card stat-metric h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Языковое соответствие</div>
              <div class="metric-value {% if metrics.lang_compliance == 100 %}text-success{% elif metrics.lang_compliance >= 80 %}text-warning{% else %}text-danger{% endif %}">
                {{ metrics.lang_compliance }}%
              </div>
              <div class="text-muted small">{{ metrics.lang_correct }}/{{ metrics.lang_total }} KZ/ENG обращений</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card stat-metric h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Отклонение нагрузки</div>
              <div class="metric-value text-info">{{ metrics.load_std }}</div>
              <div class="text-muted small">Чем ниже, тем равномернее</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card stat-metric h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Доля назначенных</div>
              <div class="metric-value {% if metrics.unassigned == 0 %}text-success{% else %}text-warning{% endif %}">
                {{ ((metrics.assigned / metrics.total * 100) | round(1)) if metrics.total else 0 }}%
              </div>
              <div class="text-muted small">{{ metrics.assigned }}/{{ metrics.total }} назначено</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Графики -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">По типу обращения</div>
        <div class="card-body"><canvas id="typeChart" height="180"></canvas></div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm">
        <div class="card-header">Тональность</div>
        <div class="card-body"><canvas id="sentimentChart" height="180"></canvas></div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm">
        <div class="card-header">Язык</div>
        <div class="card-body"><canvas id="langChart" height="180"></canvas></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">Нагрузка менеджеров</div>
        <div class="card-body"><canvas id="workloadChart" height="180"></canvas></div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Звёздное задание: AI чат -->
  {% if processed > 0 %}
  <div class="card shadow-sm mb-4">
    <div class="card-header">&#10024; Спросить AI (Звёздное задание)</div>
    <div class="card-body">
      <div class="input-group mb-3">
        <input id="aiQuery" type="text" class="form-control"
               placeholder="Например: Покажи распределение типов обращений по офисам">
        <button class="btn btn-primary" onclick="askAI()">Спросить</button>
      </div>
      <div id="aiResult"></div>
      <canvas id="aiChart" height="120" style="display:none"></canvas>
    </div>
  </div>
  {% endif %}

  <!-- Таблица обращений -->
  <div class="card shadow-sm">
    <div class="card-header">Все обращения</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-sm mb-0 small">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Сегмент</th>
              <th>Тип</th>
              <th>Тональность</th>
              <th>П</th>
              <th>Язык</th>
              <th>Назначенный менеджер</th>
              <th>Офис</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% if rows %}
              {% for a, t, m, o in rows %}
              <tr>
                <td class="text-muted">{{ t.id }}</td>
                <td>
                  {% if t.segment == 'VIP' %}
                    <span class="badge bg-warning text-dark">VIP</span>
                  {% elif t.segment == 'Priority' %}
                    <span class="badge bg-danger">Priority</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ t.segment }}</span>
                  {% endif %}
                </td>
                <td>{{ a.ticket_type or '—' }}</td>
                <td>
                  {% if a.sentiment == 'Negative' %}
                    <span class="badge bg-danger">Negative</span>
                  {% elif a.sentiment == 'Positive' %}
                    <span class="badge bg-success">Positive</span>
                  {% else %}
                    <span class="badge bg-secondary">Neutral</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge badge-priority
                    {% if a.priority_score >= 8 %}bg-danger
                    {% elif a.priority_score >= 5 %}bg-warning text-dark
                    {% else %}bg-secondary{% endif %}">
                    {{ a.priority_score }}
                  </span>
                </td>
                <td><span class="badge bg-info text-dark">{{ a.language }}</span></td>
                <td>
                  {% if m %}{{ m.full_name }}{% else %}<span class="text-danger">НЕ НАЗНАЧЕН</span>{% endif %}
                </td>
                <td>{{ o.name if o else '—' }}</td>
                <td>
                  <a href="/ticket/{{ t.id }}" class="btn btn-outline-primary btn-sm py-0 px-1">Детали</a>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="9" class="text-center text-muted py-4">
                Обращения ещё не обработаны. Нажмите «Запустить обработку» для начала.
              </td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div><!-- /container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ── Графики ────────────────────────────────────────────
{% if processed > 0 %}
const COLORS = ['#0d6efd','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107','#198754','#20c997','#0dcaf0','#adb5bd','#6610f2','#e83e8c'];

function makeBar(id, labels, values) {
  new Chart(document.getElementById(id), {
    type: 'bar',
    data: { labels, datasets: [{ data: values, backgroundColor: COLORS, borderRadius: 4 }] },
    options: { plugins: { legend: { display: false } }, responsive: true,
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
  });
}
function makePie(id, labels, values, type='pie') {
  new Chart(document.getElementById(id), {
    type,
    data: { labels, datasets: [{ data: values, backgroundColor: COLORS }] },
    options: { responsive: true }
  });
}
function makeHBar(id, labels, values) {
  new Chart(document.getElementById(id), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Обращения', data: values, backgroundColor: '#6f42c1', borderRadius: 4 }] },
    options: {
      indexAxis: 'y', responsive: true,
      plugins: { legend: { display: false } },
      scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
}

makeBar('typeChart',      {{ type_labels|safe }},      {{ type_values|safe }});
makePie('sentimentChart', {{ sentiment_labels|safe }},  {{ sentiment_values|safe }});
makePie('langChart',      {{ lang_labels|safe }},       {{ lang_values|safe }}, 'doughnut');
makeHBar('workloadChart', {{ mgr_labels|safe }},        {{ mgr_values|safe }});
{% endif %}

// ── AI чат ─────────────────────────────────────────
let aiChartObj = null;
async function askAI() {
  const q = document.getElementById('aiQuery').value.trim();
  if (!q) return;
  document.getElementById('aiResult').innerHTML = '<span class="text-muted">Анализирую…</span>';

  try {
    const res = await fetch('/ask', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({query: q})
    });
    const data = await res.json();
    if (data.error) { document.getElementById('aiResult').innerHTML = `<span class="text-danger">${data.error}</span>`; return; }

    document.getElementById('aiResult').innerHTML = `<strong>${data.title}</strong>`;
    const canvas = document.getElementById('aiChart');
    canvas.style.display = 'block';
    if (aiChartObj) aiChartObj.destroy();
    aiChartObj = new Chart(canvas, {
      type: data.chart_type || 'bar',
      data: { labels: data.labels, datasets: [{ data: data.values, backgroundColor: COLORS, borderRadius: 4 }] },
      options: { responsive: true, plugins: { legend: { display: data.chart_type !== 'bar' } } }
    });
  } catch(e) {
    document.getElementById('aiResult').innerHTML = `<span class="text-danger">Ошибка: ${e}</span>`;
  }
}
document.getElementById('aiQuery') && document.getElementById('aiQuery').addEventListener('keydown', e => { if (e.key === 'Enter') askAI(); });

// ── Оверлей обработки ──────────────────────────────
function startProcessing(e) {
  e.preventDefault();
  const btn = document.getElementById('btnProcess');
  btn.innerHTML = '&#9203; Обработка…';
  btn.classList.replace('btn-success', 'btn-warning');
  btn.style.pointerEvents = 'none';

  const overlay = document.getElementById('processingOverlay');
  overlay.style.display = 'flex';

  fetch('/process', { redirect: 'follow' })
    .then(() => { window.location.reload(); })
    .catch(() => { window.location.reload(); });
}
</script>

<div id="processingOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
  <div class="text-center text-white">
    <div class="spinner-border text-light mb-3" style="width:3rem;height:3rem;" role="status"></div>
    <h4>AI обрабатывает обращения…</h4>
    <p class="text-light">Анализ и маршрутизация обращений. Это может занять 1–3 минуты.</p>
  </div>
</div>
</body>
</html>
